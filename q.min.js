!function(e,n){"function"==typeof define&&define.amd?define(n):"object"==typeof module&&module.exports?module.exports=n():e.$q=n()}(this,function(){function e(e,n,t,o){if("function"==typeof e)try{n.resolve(e(t))}catch(e){n.reject(e)}else n[o?"resolve":"reject"](t)}function n(n,t,o){if(!n.resolved){n.resolved=!0,n.result=t,n.fulfilled=o||!1;var r=n.queue.splice(0);n.queue=null,setTimeout(function(){for(var n=0,i=r.length;n<i;n++)e(r[n][o?0:1],r[n][2],t,o)},0)}}function t(e,n,t){var r=!1;try{e.call(t,function(e){r||(r=!0,o(n,e,!0))},function(e){r||(r=!0,o(n,e,!1))})}catch(e){if(r)return;o(n,e,!1)}}function o(e,o,r){var i;if(!o||"object"!=typeof o&&"function"!=typeof o)n(e,o,r);else try{i=o.then,r&&"function"==typeof i?t(i,e,o):n(e,o,r)}catch(t){n(e,t,!1)}}function r(e,n,t){e.resolving||(e.resolving=!0,n===e.promise&&(t=!1,n=new TypeError("A promise can not be resolved by itself")),o(e,n,t))}function i(e){if(!(this instanceof i))return new i(e);if("function"!=typeof e)throw new TypeError("Promise resolver "+e+" is not a function");var n={queue:[],promise:this};this.__promise=n;try{e(function(e){r(n,e,!0)},function(e){r(n,e,!1)})}catch(e){r(n,e,!1)}}function u(e,n){for(var t=0,o=e.length;t<o;t++)n(e[t],t)}return i.prototype.then=function(n,t){var o=this.__promise,r=i.defer();return o.queue?o.queue.push([n,t,r]):setTimeout(function(){e(o.fulfilled?n:t,r,o.result,o.fulfilled)},0),r.promise},i.prototype.catch=function(e){return this.then(null,e)},i.defer=function(){var e={};return e.promise=new i(function(n,t){e.resolve=n,e.reject=t}),e},i.when=function(e){return e&&e.then?e:i.resolve(e)},i.resolve=function(e){return new i(function(n){n(e)})},i.reject=function(e){return new i(function(n,t){t(e)})},i.all=function(e){return new i(function(n,t){var o=e.length,r=[];u(e,function(e,u){(e.then?e:i.resolve(e)).then(function(e){r[u]=e,0===--o&&n(r)},function(e){o!==-1&&t(e)})})})},i.race=function(e){return new i(function(n,t){var o=!1;u(e,function(e){o||(e.then?e:i.resolve(e)).then(function(e){o||(o=!0,n(e))},function(e){o||(o=!0,t(e))})})})},i});