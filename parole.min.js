function runHandler(e,n,r,o){if("function"==typeof e)try{n.resolve(e(r))}catch(e){n.reject(e)}else n[o?"resolve":"reject"](r)}function resolvePromise(e,n,r){if(!e.resolved){e.resolved=!0,e.result=n,e.fulfilled=r||!1;var o=e.queue.splice(0);e.queue=null,setTimeout(function(){for(var e=0,t=o.length;e<t;e++)runHandler(o[e][r?0:1],o[e][2],n,r)},0)}}function runThenable(e,n,r){var o=!1;try{e.call(r,function(e){o||(o=!0,xThen(n,e,!0))},function(e){o||(o=!0,xThen(n,e,!1))})}catch(e){if(o)return;xThen(n,e,!1)}}function xThen(e,n,r){var o;if(!n||"object"!=typeof n&&"function"!=typeof n)resolvePromise(e,n,r);else try{o=n.then,r&&"function"==typeof o?runThenable(o,e,n):resolvePromise(e,n,r)}catch(n){resolvePromise(e,n,!1)}}function resolveProcedure(e,n,r){e.resolving||(e.resolving=!0,n===e.promise&&(r=!1,n=new TypeError("A promise can not be resolved by itself")),xThen(e,n,r))}function Parole(e){if(!(this instanceof Parole))return new Parole(e);if("function"!=typeof e)throw new TypeError("Promise resolver "+e+" is not a function");var n={queue:[],promise:this};this.__promise=n;try{e(function(e){resolveProcedure(n,e,!0)},function(e){resolveProcedure(n,e,!1)})}catch(e){resolveProcedure(n,e,!1)}}function each(e,n){for(var r=0,o=e.length;r<o;r++)n(e[r],r)}Parole.prototype.then=function(e,n){var r=this.__promise,o=Parole.defer();return r.queue?r.queue.push([e,n,o]):setTimeout(function(){runHandler(r.fulfilled?e:n,o,r.result,r.fulfilled)},0),o.promise},Parole.prototype.catch=function(e){return this.then(null,e)},Parole.defer=function(){var e={};return e.promise=new Parole(function(n,r){e.resolve=n,e.reject=r}),e},Parole.when=function(e){return e&&e.then?e:Parole.resolve(e)},Parole.resolve=function(e){return new Parole(function(n){n(e)})},Parole.reject=function(e){return new Parole(function(n,r){r(e)})},Parole.all=function(e){return new Parole(function(n,r){var o=e.length,t=[];each(e,function(e,u){(e.then?e:Parole.resolve(e)).then(function(e){t[u]=e,0===--o&&n(t)},function(e){o!==-1&&r(e)})})})},Parole.race=function(e){return new Parole(function(n,r){var o=!1;each(e,function(e){o||(e.then?e:Parole.resolve(e)).then(function(e){o||(o=!0,n(e))},function(e){o||(o=!0,r(e))})})})},module.exports=Parole;